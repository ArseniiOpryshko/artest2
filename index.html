<!DOCTYPE html>
<html>

<head>
    <title>AR.js A-Frame Location-based</title>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<button id="startAR">Start AR</button>
<canvas></canvas>

<body>

</body>
<script>
    async function startAR() {
        let webxrPolyfill = null;

        if (!navigator.xr) {
            alert(" WebXR not supported in this browser. using polyfill");
            webxrPolyfill = new WebXRPolyfill();
        }

        if (navigator.xr) {
            alert(" WebXR is supported!");

            try {
                const supported = await navigator.xr.isSessionSupported('inline');
                if (!supported) {
                    alert(" AR is not supported on this device/browser.");
                    return;
                }

                alert(" AR is supported!");

                const session = await createInlineSession(navigator.xr);
                alert(" AR session started!");

                await runSession(session)

            } catch (error) {
                alert(" Error starting AR session:" + error);
            }
        }
    }


    async function createInlineSession(xr) {
        session = await xr.requestSession("immersive-ar", {
            optionalFeatures: ["unbounded"],
        });
        return session;
    }

    async function runSession(session) {
        const canvas = document.querySelector("canvas");
        gl = canvas.getContext("webgl", { xrCompatible: true });

        session.updateRenderState({
            baseLayer: new XRWebGLLayer(session, gl),
        });

        referenceSpace = await session.requestReferenceSpace("unbounded").catch(() => {
            alert(" AR is supported!");
            return session.requestReferenceSpace("local");
        });

        animationFrameRequestID = session.requestAnimationFrame(onDrawFrame);
    }

    function onDrawFrame(time, frame) {
        animationFrameRequestID = session.requestAnimationFrame(onDrawFrame);

        let pose = frame.getViewerPose(referenceSpace);
        if (!pose) return;

        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        drawScene();
    }

    function drawScene() {
        // Simple WebGL object: a rotating triangle
        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        // Set up a simple rotating triangle (replace with actual 3D objects)
        const vertices = new Float32Array([
            0.0, 0.5, 0.0,
            -0.5, -0.5, 0.0,
            0.5, -0.5, 0.0,
        ]);

        const vertexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

        const vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, `
                attribute vec3 coordinates;
                void main(void) {
                    gl_Position = vec4(coordinates, 1.0);
                }
            `);
        gl.compileShader(vertexShader);

        const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fragmentShader, `
                void main(void) {
                    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
                }
            `);
        gl.compileShader(fragmentShader);

        const shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);
        gl.useProgram(shaderProgram);

        const coord = gl.getAttribLocation(shaderProgram, "coordinates");
        gl.vertexAttribPointer(coord, 3, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(coord);

        gl.drawArrays(gl.TRIANGLES, 0, 3);
    }


    document.getElementById("startAR").addEventListener("click", startAR);

</script>

</html>